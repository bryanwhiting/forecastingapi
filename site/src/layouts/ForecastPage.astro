---
import MainLayout from './MainLayout.astro';
import Navbar from '../components/Navbar.astro';
const { data } = Astro.props;
const history = data.history ?? [];
const forecast = data.forecast ?? [];
const backtest = data.backtest ?? [];

const runTitle = data?.meta?.slug || data.request?.run_name_root || (data.request?.series_names || []).join(', ') || 'series';

const backtestLeaderboard = Object.values(
  backtest.reduce((acc, row) => {
    const key = row.model;
    if (!acc[key]) acc[key] = { model: key, total: 0, count: 0 };
    acc[key].total += Number(row.smape || 0);
    acc[key].count += 1;
    return acc;
  }, {})
)
  .map((r) => ({ model: r.model, avgSmape: r.count ? r.total / r.count : 0, samples: r.count }))
  .sort((a, b) => a.avgSmape - b.avgSmape);

const parseDs = (v) => {
  const s = String(v ?? '');
  const normalized = s.includes('T') ? s : s.replace(' ', 'T');
  const d = new Date(normalized);
  return Number.isNaN(d.getTime()) ? null : d;
};

const points = [
  ...history.map((r) => ({ ...r, type: 'actual' })),
  ...forecast.map((r) => ({ ...r, type: 'forecast' })),
]
  .map((p) => {
    const d = parseDs(p.ds);
    if (!d) return null;
    return { ...p, iso: d.toISOString() };
  })
  .filter(Boolean);

const labels = [...new Set(points.map((p) => p.iso))].sort();

const actualValues = labels.map((l) => {
  const row = points.find((p) => p.type === 'actual' && p.iso === l);
  return row ? Number(row.y) : null;
});

const modelNames = [...new Set(points.filter((p) => p.type === 'forecast').map((p) => p.model))];
const modelSeries = modelNames.map((model) => ({
  model,
  values: labels.map((l) => {
    const row = points.find((p) => p.type === 'forecast' && p.model === model && p.iso === l);
    return row ? Number(row.yhat) : null;
  }),
}));

const allY = [
  ...actualValues.filter((v) => Number.isFinite(v)),
  ...modelSeries.flatMap((s) => s.values.filter((v) => Number.isFinite(v))),
];

const yMin = allY.length ? Math.min(...allY) : 0;
const yMax = allY.length ? Math.max(...allY) : 1;

const W = 920;
const H = 340;
const PAD = { t: 18, r: 18, b: 40, l: 44 };
const innerW = W - PAD.l - PAD.r;
const innerH = H - PAD.t - PAD.b;

const xFor = (i) => PAD.l + (labels.length <= 1 ? 0 : (i / (labels.length - 1)) * innerW);
const yFor = (v) => {
  if (!Number.isFinite(v)) return null;
  const range = yMax - yMin || 1;
  return PAD.t + (1 - (v - yMin) / range) * innerH;
};

const toPath = (arr) => {
  let d = '';
  arr.forEach((v, i) => {
    const y = yFor(v);
    if (y === null) return;
    const x = xFor(i);
    d += d ? ` L ${x} ${y}` : `M ${x} ${y}`;
  });
  return d;
};

const actualPath = toPath(actualValues);
const colors = ['#ef4444', '#22c55e', '#a855f7', '#f97316'];
---
<MainLayout title={`Forecast ${runTitle}`}>
  <Navbar />
  <h1 class="text-2xl font-bold mt-4">Forecast: {runTitle}</h1>
  <p class="text-slate-400 mt-1">Backend: {data.backend} · Granularity: {data.request.granularity} · Horizon: {data.request.horizon}</p>
  {data?.meta?.github?.run_url && <p class="text-sm mt-1"><a href={data.meta.github.run_url} target="_blank" rel="noreferrer" class="text-sky-300">GitHub action run ↗</a></p>}

  <section class="mt-4 rounded-xl border border-slate-700 bg-slate-900/70 p-4">
    <h2 class="font-semibold mb-2">Actual vs Forecast</h2>
    <div class="overflow-x-auto">
      <svg viewBox={`0 0 ${W} ${H}`} class="min-w-[760px] w-full rounded bg-slate-950">
        <rect x={PAD.l} y={PAD.t} width={innerW} height={innerH} fill="none" stroke="#1e293b" />
        {Array.from({ length: 5 }).map((_, i) => {
          const y = PAD.t + (i / 4) * innerH;
          const val = (yMax - ((i / 4) * (yMax - yMin))).toFixed(1);
          return (
            <g>
              <line x1={PAD.l} y1={y} x2={W - PAD.r} y2={y} stroke="#0f172a" />
              <text x="6" y={y + 4} font-size="11" fill="#94a3b8">{val}</text>
            </g>
          );
        })}

        {actualPath && <path d={actualPath} fill="none" stroke="#38bdf8" stroke-width="2" />}
        {modelSeries.map((s, idx) => {
          const d = toPath(s.values);
          return d ? <path d={d} fill="none" stroke={colors[idx % colors.length]} stroke-width="2" stroke-dasharray="6 4" /> : null;
        })}
      </svg>
    </div>

    <div class="mt-2 flex flex-wrap gap-3 text-xs text-slate-300">
      <span class="inline-flex items-center gap-1"><span class="inline-block w-4 h-[2px] bg-sky-400"></span>Actual</span>
      {modelSeries.map((s, idx) => (
        <span class="inline-flex items-center gap-1"><span class="inline-block w-4 h-[2px]" style={`background:${colors[idx % colors.length]}`}></span>Forecast ({s.model})</span>
      ))}
    </div>
  </section>

  {backtest.length > 0 && (
    <section class="mt-4 rounded-xl border border-slate-700 bg-slate-900/70 p-4 overflow-x-auto">
      <h2 class="font-semibold mb-2">Backtest details</h2>
      <table class="min-w-[760px] text-sm w-full">
        <thead><tr class="text-slate-300"><th class="p-2 text-left">Window</th><th class="p-2 text-left">Model</th><th class="p-2 text-left">SMAPE</th><th class="p-2 text-left">Horizon</th><th class="p-2 text-left">Holdout Range</th></tr></thead>
        <tbody>
          {backtest.map((row) => (
            <tr>
              <td class="p-2">{row.window}</td><td class="p-2">{row.model}</td><td class="p-2">{row.smape}</td><td class="p-2">{row.horizon}</td><td class="p-2">{String(row.holdout_start)} → {String(row.holdout_end)}</td>
            </tr>
          ))}
        </tbody>
      </table>

      {backtestLeaderboard.length > 0 && (
        <>
          <h3 class="font-semibold mt-4 mb-2">Backtest leaderboard (this run)</h3>
          <table class="min-w-[420px] text-sm w-full">
            <thead><tr class="text-slate-300"><th class="p-2 text-left">Rank</th><th class="p-2 text-left">Model</th><th class="p-2 text-left">Avg SMAPE</th><th class="p-2 text-left">Samples</th></tr></thead>
            <tbody>
              {backtestLeaderboard.map((row, idx) => (
                <tr>
                  <td class="p-2">{idx + 1}</td><td class={`p-2 ${idx===0?'text-emerald-400 font-semibold':''}`}>{row.model}</td><td class="p-2">{row.avgSmape.toFixed(4)}</td><td class="p-2">{row.samples}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </>
      )}
    </section>
  )}

  <details class="mt-4 rounded-xl border border-slate-700 bg-slate-900/70 p-4">
    <summary class="cursor-pointer font-semibold">Payload</summary>
    <pre class="mt-2 overflow-auto rounded bg-slate-950 p-3 text-xs">{JSON.stringify(data.request, null, 2)}</pre>
  </details>
</MainLayout>
